# Microsoft认证流程说明

## 简介

obsidian-mstodo-sync 插件使用OAuth 2.0设备代码流程与Microsoft账户进行认证，允许插件访问您的Microsoft To Do数据。本文档将详细说明认证流程及其实现。

## 认证流程

### 用户友好的认证体验

我们设计了一个直观、用户友好的认证流程：

1. **开始认证**：用户点击开始认证按钮
2. **获取验证码**：系统生成一个验证码并提供Microsoft验证链接
3. **完成验证**：用户在Microsoft网站输入验证码，授权应用访问
4. **认证完成**：授权成功后，系统自动获取和存储访问令牌

### 技术实现

认证流程采用OAuth 2.0设备代码授权流程，特别适合没有Web浏览器或输入受限的设备。该流程包括：

1. **请求设备代码**：应用请求一个用户代码和验证URL
2. **用户授权**：用户在单独的设备上访问验证URL并输入代码
3. **轮询令牌**：应用后台轮询Microsoft授权服务器
4. **获取令牌**：一旦用户完成授权，应用获取访问令牌

## 使用方法

### API调试工具

我们提供了一个API调试工具，便于开发者测试Microsoft To Do API：

1. 启动API服务器：
   ```bash
   npm run api
   ```

2. 访问API文档：
   ```
   http://localhost:3000/api-docs
   ```

3. 完成认证：
   - 点击页面顶部的"微软认证"按钮
   - 在打开的认证页面中，点击"开始认证"
   - 复制显示的验证码
   - 点击"打开Microsoft登录页面"并输入验证码
   - 按照Microsoft提示完成授权
   - 认证成功后自动返回API文档

4. 测试API：
   - 使用Swagger UI测试各种Microsoft To Do API
   - 所有API调用都会自动使用获取的访问令牌
   - 令牌缓存在浏览器中，无需重复认证

### 在插件中使用

对于插件用户，认证流程在Obsidian中直接进行：

1. 安装并启用插件
2. 打开插件设置
3. 点击"连接Microsoft账户"
4. 按照提示完成设备认证流程
5. 认证成功后即可使用同步功能

## 安全注意事项

1. **令牌安全存储**：访问令牌使用安全机制加密存储
2. **自动令牌刷新**：系统会在令牌过期前自动刷新，减少用户重复认证
3. **注销功能**：用户可随时撤销授权，清除所有认证信息
4. **最小权限原则**：插件仅请求必要的"Tasks.ReadWrite"权限

## 故障排除

如果认证流程中遇到问题，请尝试以下步骤：

1. **验证码过期**：如果验证码已过期，重新点击"开始认证"获取新代码
2. **认证失败**：确保正确输入验证码，检查Microsoft账户状态
3. **访问被拒绝**：可能需要开启Microsoft账户的应用访问权限
4. **令牌过期**：点击"清除认证状态"并重新进行认证
5. **缓存问题**：清除浏览器缓存或删除`.cache`目录中的令牌缓存文件

## 技术架构

认证流程涉及以下关键组件：

1. **MicrosoftClientProvider**：负责处理OAuth认证流程与令牌管理
2. **设备代码认证UI**：提供友好的用户界面引导完成认证
3. **令牌缓存机制**：安全存储访问令牌，支持自动刷新
4. **认证中间件**：API服务器中验证请求合法性的组件

## 隐私声明

本插件与API调试工具严格保护您的隐私：

1. 认证过程不会收集您的Microsoft凭据
2. 令牌仅存储在本地，不会传输到第三方服务器
3. 访问范围严格限制在Microsoft To Do相关数据
4. 您可以随时撤销授权，停止数据访问

## 进一步资源

- [Microsoft身份平台文档](https://docs.microsoft.com/zh-cn/azure/active-directory/develop/)
- [OAuth 2.0设备授权流程](https://docs.microsoft.com/zh-cn/azure/active-directory/develop/v2-oauth2-device-code)
- [Microsoft Graph API文档](https://docs.microsoft.com/zh-cn/graph/api/resources/todo-overview) 